[uwsgi]
# Core uWSGI behavior
strict = true
master = true
enable-threads = true
vacuum = true
need-app = true

# Application entry point
http = :8000
wsgi-file = main/wsgi.py
static-map = /iiif-metadata/static=/app/static/

# Process and thread configuration
processes = 4
threads = 4

# Connection handling and queue management
listen = 512
thunder-lock = true

# Request buffering and size limits
buffer-size = 32768
post-buffering = 8192
post-buffering-bufsize = 65536

# Timeouts and request limits
harakiri = 30
harakiri-verbose = true
http-timeout = 75
socket-timeout = 75

# Static file offloading
offload-threads = 2

# Worker health and recycling
max-requests = 5000
max-requests-delta = 500
reload-on-rss = 512
reload-on-as = 768

# Graceful shutdown and signal handling
die-on-term = true
hook-master-start = unix_signal:15 gracefully_kill_them_all
no-orphans = true
worker-reload-mercy = 15
reload-mercy = 15

# Logging configuration
disable-logging = false
log-4xx = true
log-5xx = true
log-format = {"timestamp": "%(ftime)", "method": "%(method)", "uri": "%(uri)", "proto": "%(proto)", "status": %(status), "size": %(size), "msecs": %(msecs), "addr": "%(addr)", "worker": %(wid)}
