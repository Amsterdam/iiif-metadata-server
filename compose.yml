x-common-depends-on: &common-depends-on
  migrate:
    condition: service_completed_successfully
  azurite:
    condition: service_healthy

x-common-env: &common-env
  LOG_LEVEL: "WARNING"
  DJANGO_LOG_LEVEL: "WARNING"
  WABO_ENABLED: "true"
  SECRET_KEY: "insecure"
  JWT_SECRET_KEY: "insecure"
  DATABASE_HOST: "iiif-metadata-database"
  PYTHONBREAKPOINT: true
  UWSGI_STATIC_MAP: '/iiif-metadata/static=/static'
  AZURITE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://iiif-metadata-azurite:10000/devstoreaccount1;"
  AZURITE_QUEUE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;QueueEndpoint=http://iiif-metadata-azurite:10001/devstoreaccount1;"
  OTEL_SERVICE_NAME: "iiif-metadata"
  OTEL_TRACES_SAMPLER: "always_on"
  OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
  OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_REQUEST: ".*"
  OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_RESPONSE: ".*"
  OTEL_EXPORTER_OTLP_ENDPOINT: http://iiif-metadata-otel-collector:4317

x-app: &base-app
  build:
    context: .
    target: app
  depends_on:
    <<: *common-depends-on
  volumes:
    - ./src:/app/src
    - ./deploy:/app/deploy
  networks:
    - amsterdam-bouwdossiers
    - default

volumes:
  azurite_data:
  db_data:

services:
  database:
    container_name: iiif-metadata-database
    image: postgis/postgis:15-3.4
    ports:
      - 5432
    environment:
      POSTGRES_DB: dev
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
    volumes:
      - "~/.ssh/datapunt.key:/root/.ssh/datapunt.key"
    healthcheck:
      test: [ "CMD", "pg_isready", "-q", "-d", "dev", "-U", "dev" ]
      interval: 10s
      timeout: 5s
      retries: 3

  migrate:
    container_name: iiif-metadata-migrate
    build:
      context: .
      target: app
    environment:
      SECRET_KEY: "insecure"
      DJANGO_SETTINGS_MODULE: main.settings
      OTEL_SDK_DISABLED: true
    depends_on:
      database:
        condition: service_healthy
    volumes:
      - .:/app
    user: 1000:1000
    command: python manage.py migrate --noinput
    restart: "no"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512mb
        reservations:
          cpus: "0.25"
          memory: 256M

  azurite:
    container_name: iiif-metadata-azurite
    image: mcr.microsoft.com/azure-storage/azurite:latest
    ports:
      - "10000" # Blob service
    volumes:
      - azurite_data:/data
    command: >
      azurite
      -l /data
      --blobHost 0.0.0.0
      --loose
    healthcheck:
      test: nc 127.0.0.1 10000 -z
      interval: 1s
      retries: 30

  app:
    container_name: iiif-metadata-app
    <<: *base-app
    build:
      context: .
      target: app
    image: ${REGISTRY:-localhost:5000}/${REPOSITORY:-opdrachten/iiif-metadata-server}:${VERSION:-latest}
    ports:
      - "8000:8000"
    environment:
      <<: *common-env
    depends_on:
      <<: *common-depends-on
      otel-collector:
        condition: service_started
    command: /app/deploy/docker-run.sh
    user: 1000:1000

  dev:
    container_name: iiif-metadata-dev
    <<: *base-app
    hostname: metadata-server
    build:
      context: .
      target: dev
    ports:
      - "8001:8000"
    environment:
      <<: *common-env
      LOG_LEVEL: "DEBUG"
      DJANGO_LOG_LEVEL: "DEBUG"
      DEBUG: "true"
      USE_JWKS_TEST_KEY: "true"
    depends_on:
      <<: *common-depends-on
      otel-collector:
        condition: service_started
    command: python manage.py runserver 0.0.0.0:8000
    user: 1000:1000

  test:
    container_name: iiif-metadata-test
    <<: *base-app
    build:  
      context: .
      target: tests
    environment:
      <<: *common-env
      USE_JWKS_TEST_KEY: "true"
      SECRET_KEY: "insecure"
      OTEL_SDK_DISABLED: true

  linting:
    container_name: iiif-metadata-linting
    build:
      context: .
      target: linting
    volumes:
      - .:/app/
    user: 1000:1000

  otel-collector:
    container_name: iiif-metadata-otel-collector
    build:
      context: otel-collector
    volumes:
      - ./otel-collector/config.local.yaml:/etc/otelcol-contrib/config.yaml
    depends_on:
      - jaeger
    ports:
      - "14317:4317"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 256M
        reservations:
          cpus: "0.05"
          memory: 128M

  jaeger:
    container_name: iiif-metadata-jaeger
    image: jaegertracing/jaeger:2.8.0
    ports:
      # ui
      - "26686:16686"
      # grpc
      - "24317:4317"
    environment:
      LOG_LEVEL: debug

networks:
  amsterdam-bouwdossiers:
    name: amsterdam-bouwdossiers
    driver: bridge
